name: Multi-College Data Sync and Deploy

on:
  schedule:
    - cron: '0 21 * * *'   # 5:00 PM ET
    - cron: '0 2 * * *'    # 10:00 PM ET
    - cron: '0 12 * * *'   # 8:00 AM ET
  workflow_dispatch:  # Allow manual triggering

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        school: [GCU, HARVARD, VMI, FLORIDA, CBU, CREIGHTON, UNM]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.0'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libcurl4-openssl-dev \
          libssl-dev \
          libxml2-dev \
          libfontconfig1-dev \
          libharfbuzz-dev \
          libfribidi-dev \
          libfreetype6-dev \
          libpng-dev \
          libjpeg-dev \
          libtiff-dev \
          libfontconfig1 \
          libxcb1 \
          libicu-dev \
          libcairo2-dev \
          libgdal-dev \
          libgeos-dev \
          libproj-dev \
          libudunits2-dev

        
    - name: Install R packages
      run: Rscript install_packages.R
          
    - name: Configure rsconnect
      env:
        SHINYAPPS_ACCOUNT: ${{ secrets.SHINYAPPS_ACCOUNT }}
        SHINYAPPS_TOKEN: ${{ secrets.SHINYAPPS_TOKEN }}
        SHINYAPPS_SECRET: ${{ secrets.SHINYAPPS_SECRET }}
      run: |
        Rscript -e "rsconnect::setAccountInfo(name='${{ secrets.SHINYAPPS_ACCOUNT }}', token='${{ secrets.SHINYAPPS_TOKEN }}', secret='${{ secrets.SHINYAPPS_SECRET }}')"
        
    - name: Sync ${{ matrix.school }} data
      env:
        SCHOOL_CODE: ${{ matrix.school }}
      run: Rscript automated_data_sync.R
        
    - name: Check if data directory exists for ${{ matrix.school }}
      id: check_data
      run: |
        school_lower=$(echo "${{ matrix.school }}" | tr '[:upper:]' '[:lower:]')
        if [ -d "data/${school_lower}" ] && [ "$(ls -A data/${school_lower})" ]; then
          echo "data_updated=true" >> $GITHUB_OUTPUT
          echo "Found data files for ${{ matrix.school }}:"
          ls -la data/${school_lower}/
        else
          echo "data_updated=false" >> $GITHUB_OUTPUT
          echo "No data directory or no files found for ${{ matrix.school }}"
        fi
        
    - name: Deploy ${{ matrix.school }} to shinyapps.io
      if: steps.check_data.outputs.data_updated == 'true' || github.event_name == 'workflow_dispatch'
      env:
        SCHOOL_CODE: ${{ matrix.school }}
      run: Rscript deploy_script.R
      
    - name: Commit updated data for ${{ matrix.school }}
      if: steps.check_data.outputs.data_updated == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        school_lower=$(echo "${{ matrix.school }}" | tr '[:upper:]' '[:lower:]')
        git add data/${school_lower}/
        if git diff --staged --quiet; then
          echo "No changes to commit for ${{ matrix.school }}"
        else
          git commit -m "Auto-update ${{ matrix.school }} data $(date)"
          git pull --rebase origin main
          git push
        fi
